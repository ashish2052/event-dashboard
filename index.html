<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>November 2025 Event Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: #050A1F;
  color: #E6EBFF;
}

/* HEADER */
.header {
  text-align: center;
  padding: 25px 10px;
  background: rgba(0,0,0,0.25);
  border-bottom: 1px solid #0d1a40;
  box-shadow: 0 0 25px #002a80 inset;
}
.header-title {
  font-size: 38px;
  font-weight: 700;
  color: #9EC5FF;
  text-shadow: 0 0 12px #007bff;
}
.header-sub {
  margin-top: 6px;
  color: #7AB8FF;
  font-size: 15px;
  opacity: 0.9;
}
.live-box {
  margin: auto;
  margin-top: 12px;
  padding: 8px 20px;
  border-radius: 40px;
  border: 1px solid #1f3f75;
  background: #06152F;
  width: fit-content;
  color: #9EC5FF;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 0 10px #0055ff55 inset;
}
.live-dot {
  width: 10px;
  height: 10px;
  background: #00ff88;
  border-radius: 50%;
  box-shadow: 0 0 10px #00ff88;
}

/* TABS */
.tab-container {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding: 18px 10px;
  background: #07102d;
  border-bottom: 1px solid #0b1f47;
}
.tab-btn {
  padding: 10px 22px;
  border-radius: 10px;
  border: 1px solid #1e366e;
  color: #9ec5ff;
  background: #0c1b3f;
  cursor: pointer;
  transition: 0.25s;
  font-size: 15px;
}
.tab-btn:hover {
  background: #12285a;
  box-shadow: 0 0 10px #0066ff;
}
.tab-btn.active {
  background: #003a85;
  color: white;
  border-color: #1c6bff;
  box-shadow: 0 0 15px #1c6bff, 0 0 25px #0044ff;
}
.tab-page { display: none; }

/* SECTION TITLE */
.section-title {
  padding-left: 20px;
  color: #7AB8FF;
  margin-bottom: 15px;
}

/* CARDS */
.card-grid {
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 18px;
}
.card {
  background: #0C153C;
  padding: 20px;
  border-radius: 14px;
  border: 1px solid #1d2f70;
  transition: 0.25s;
  cursor: pointer;
  box-shadow: 0 0 12px #001a33 inset;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 0 14px #009dff;
}
.card-title {
  font-size: 15px;
  color: #8EBEFF;
  margin-bottom: 6px;
}
.card-value {
  font-size: 30px;
  font-weight: 700;
  color: white;
  text-shadow: 0 0 10px #00baff;
}
.card-sub {
  margin-top: 4px;
  font-size: 13px;
  color: #6fd0ff;
}

/* ANALYTICS GRID */
.analytics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  padding: 20px;
}

/* CHART BOX */
.chart-box {
  background: #0C153C;
  padding: 20px;
  border-radius: 14px;
  border: 1px solid #1d2f70;
  box-shadow: 0 0 12px #001a33 inset;
}

/* INSIGHT BOX — FIXED COLOR + PROPER SIZE */
.insight-box {
  background: #0C153C;
  border: 1px solid #23335a;
  padding: 22px;
  border-radius: 12px;
  color: #cde2ff;
  font-size: 15.5px;
  line-height: 1.75;
  box-shadow: 0 0 10px #122244 inset;
}

/* ROI CARDS */
.roi-card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  gap: 20px;
  padding: 20px;
}
.roi-card {
  background: #141426;
  border: 1px solid #23335a;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 0 10px #122244 inset;
}
.roi-title {
  color: #7AB8FF;
  margin-bottom: 6px;
}
.roi-value {
  font-size: 24px;
  font-weight: 700;
  color: white;
  text-shadow: 0 0 10px #00c3ff;
}

/* SEARCH */
.search-box {
  margin-left: 20px;
  margin-bottom: 20px;
  padding: 10px 15px;
  width: 50%;
  border-radius: 8px;
  border: 1px solid #1C3B7A;
  background: #0a1433;
  color: #9EC5FF;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #0c153c;
  border: 1px solid #1c3b7a;
}
th {
  background: #15234a;
  padding: 12px;
  color: #9ec5ff;
}
td {
  padding: 10px;
  border-bottom: 1px solid #1a2e60;
  color: #dbe4ff;
}
tr:hover {
  background: #16244d;
}
</style>
/* ============================================================
   GLOBAL STORAGE
============================================================ */
let attendeesData = [];
let expenseData = [];
let charts = {};

/* ============================================================
   TAB SWITCHING
============================================================ */
function openTab(tabName) {
  document.querySelectorAll(".tab-page").forEach(t => t.style.display = "none");
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

  document.getElementById(tabName).style.display = "block";
  [...document.querySelectorAll(".tab-btn")].find(btn =>
    btn.textContent.toLowerCase().includes(tabName)
  ).classList.add("active");

  if (tabName === "people") renderPeopleTable(attendeesData);
  if (tabName === "roi") renderROI();
}

/* ============================================================
   FETCH DATA FROM CLOUDLFARE WORKER
============================================================ */
async function loadData() {
  try {
    const res = await fetch("https://novevent-report-worker.ashishoct34.workers.dev/");
    const json = await res.json();

    attendeesData = json.attendees || [];
    expenseData   = json.expenses || [];

    renderCards();
    renderCharts();
    generateInsights();

  } catch (err) {
    console.error("LOAD ERROR:", err);
  }
}
loadData();

/* ============================================================
   HELPERS
============================================================ */
function pct(v, total) {
  if (!total) return "0%";
  return ((v / total) * 100).toFixed(1) + "%";
}

function groupCount(data, field) {
  const out = {};
  data.forEach(x => {
    let k = (x[field] || "").trim();
    if (!k) return;
    out[k] = (out[k] || 0) + 1;
  });
  return out;
}

/* ============================================================
   RENDER CARDS (with FIXED FILTER)
============================================================ */
function renderCards() {
  const total = attendeesData.length;

  const lost       = attendeesData.filter(x => (x.Status||"").toLowerCase()=="lost").length;
  const warm       = attendeesData.filter(x => (x.Status||"").toLowerCase()=="warm").length;
  const cold       = attendeesData.filter(x => (x.Status||"").toLowerCase()=="cold").length;
  const converted  = attendeesData.filter(x => (x.Status||"").toLowerCase()=="converted").length;
  const unassigned = attendeesData.filter(x => !x.Assignees).length;
  const missing    = attendeesData.filter(x => !x.Status).length;

  window.cardFilters = [
    { title:"Total Attendees", value:total, filter:()=>attendeesData },

    { title:"Lost", value:lost, sub:pct(lost,total),
      filter:()=> attendeesData.filter(x=> (x.Status||"").toLowerCase()=="lost") },

    { title:"Warm", value:warm, sub:pct(warm,total),
      filter:()=> attendeesData.filter(x=> (x.Status||"").toLowerCase()=="warm") },

    { title:"Cold", value:cold, sub:pct(cold,total),
      filter:()=> attendeesData.filter(x=> (x.Status||"").toLowerCase()=="cold") },

    { title:"Converted", value:converted, sub:pct(converted,total),
      filter:()=> attendeesData.filter(x=> (x.Status||"").toLowerCase()=="converted") },

    { title:"Unassigned", value:unassigned,
      filter:()=> attendeesData.filter(x=> !x.Assignees) },

    { title:"Missing Status", value:missing,
      filter:()=> attendeesData.filter(x=> !x.Status) },
  ];

  document.getElementById("cards").innerHTML =
    window.cardFilters.map((c,i)=>`
      <div class="card" onclick="applyCardFilter(${i})">
        <div class="card-title">${c.title}</div>
        <div class="card-value">${c.value}</div>
        ${c.sub ? `<div class="card-sub">${c.sub}</div>` : ""}
      </div>
    `).join("");
}

function applyCardFilter(i) {
  openTab("people");
  renderPeopleTable(window.cardFilters[i].filter());
}

/* ============================================================
   PEOPLE TABLE — FULLY FIXED
============================================================ */
function renderPeopleTable(data) {
  const table = document.getElementById("peopleTable");

  if (!data || data.length === 0) {
    table.innerHTML = `<tr><td>No Data Available</td></tr>`;
    return;
  }

  const headers = Object.keys(data[0]);

  let html = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  data.forEach(row => {
    html += "<tr>" + headers.map(h => `
      <td>${(row[h] === undefined ? "" : row[h])}</td>
    `).join("") + "</tr>";
  });

  table.innerHTML = html;
}

function searchPeople() {
  const q = document.getElementById("searchInput").value.toLowerCase();

  renderPeopleTable(
    attendeesData.filter(row =>
      JSON.stringify(row).toLowerCase().includes(q)
    )
  );
}

/* ============================================================
   CHARTS (with perfect click filters)
============================================================ */
function renderCharts() {
  const country   = groupCount(attendeesData, "Country");
  const assignee  = groupCount(attendeesData, "Assignees");
  const sales     = groupCount(attendeesData, "Sales Rep");

  charts.country = makeBar("countryChart", country, key =>
    attendeesData.filter(x=> (x.Country||"").toLowerCase() === key.toLowerCase())
  );

  charts.assignee = makeBar("assigneeChart", assignee, key =>
    attendeesData.filter(x=> (x.Assignees||"").toLowerCase() === key.toLowerCase())
  );

  charts.sales = makeBar("salesChart", sales, key =>
    attendeesData.filter(x=> (x["Sales Rep"]||"").toLowerCase() === key.toLowerCase())
  );
}

function makeBar(id, obj, filterFn) {
  const el = document.getElementById(id);
  if (!el) return;

  const labels = Object.keys(obj);
  const values = Object.values(obj);

  return new Chart(el, {
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Count",
        data:values,
        backgroundColor:"#00aaff77",
        borderColor:"#33ccff",
        borderWidth:2
      }]
    },
    options:{
      onClick:(evt, items)=>{
        if (!items.length) return;
        const key = labels[items[0].index];
        openTab("people");
        renderPeopleTable(filterFn(key));
      },
      plugins:{ legend:{ labels:{ color:"#9ec5ff" } } },
      scales:{
        x:{ ticks:{ color:"#9ec5ff" } },
        y:{ ticks:{ color:"#9ec5ff" } }
      }
    }
  });
}

/* ============================================================
   INSIGHTS — FULL PARAGRAPH VERSION (UPGRADED)
============================================================ */
function generateInsights() {
  const t = attendeesData.length;
  const warm = attendeesData.filter(x=> (x.Status||"").toLowerCase()=="warm").length;
  const cold = attendeesData.filter(x=> (x.Status||"").toLowerCase()=="cold").length;
  const lost = attendeesData.filter(x=> (x.Status||"").toLowerCase()=="lost").length;
  const converted = attendeesData.filter(x=> (x.Status||"").toLowerCase()=="converted").length;

  const topCountries = Object.entries(groupCount(attendeesData, "Country"))
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(x=>`${x[0]} (${x[1]})`)
    .join(", ") || "N/A";

  const topAssignees = Object.entries(groupCount(attendeesData, "Assignees"))
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(x=>`${x[0]} (${x[1]})`)
    .join(", ") || "N/A";

  document.getElementById("insightBox").innerHTML = `
    <b>Event Summary:</b><br>
    A total of <b>${t}</b> attendees participated in the event.  
    Out of these, <b>${pct(warm,t)}</b> are warm leads,  
    <b>${pct(cold,t)}</b> are cold, and <b>${pct(lost,t)}</b> were classified as lost.  

    <br><br>
    <b>Conversion Overview:</b>  
    We recorded <b>${converted}</b> successful conversions. These should be closely monitored for follow-up and nurturing.

    <br><br>
    <b>Top Countries:</b> ${topCountries}<br>
    <b>Top Assignees:</b> ${topAssignees}<br>

    <br>
    Overall, the distribution suggests clear follow-up opportunities and strong pockets of engagement that can be strengthened further.
  `;
}

/* ============================================================
   ROI PAGE — FIXED TABLE + BETTER ANALYSIS
============================================================ */
function renderROI() {

  if (!expenseData.length) {
    document.getElementById("roiCards").innerHTML =
      `<div class="roi-card">No expense data found</div>`;
    return;
  }

  const totalExp = expenseData.reduce((s,r)=> s + (+r.Amount||0), 0);
  const totalAtt = attendeesData.length;
  const converted = attendeesData.filter(x=> (x.Status||"").toLowerCase()=="converted").length;

  document.getElementById("roiCards").innerHTML = `
    <div class="roi-card">
      <div class="roi-title">Total Expense</div>
      <div class="roi-value">Rs. ${totalExp.toLocaleString()}</div>
    </div>

    <div class="roi-card">
      <div class="roi-title">Cost per Attendee</div>
      <div class="roi-value">Rs. ${(totalExp/totalAtt).toFixed(2)}</div>
    </div>

    <div class="roi-card">
      <div class="roi-title">Cost per Converted Lead</div>
      <div class="roi-value">
      ${converted? "Rs. "+(totalExp/converted).toFixed(2) : "No conversions"}
      </div>
    </div>

    <div class="roi-card">
      <div class="roi-title">ROI Efficiency</div>
      <div class="roi-value">${(totalAtt/totalExp).toFixed(2)} attendees per Rs.1</div>
    </div>
  `;

  let html = `
    <tr>
      <th>Description</th>
      <th>Amount</th>
      <th>% of Total</th>
    </tr>
  `;

  expenseData.forEach(r=>{
    html += `
      <tr>
        <td>${r.Description}</td>
        <td>Rs. ${(+r.Amount).toLocaleString()}</td>
        <td>${pct(r.Amount, totalExp)}</td>
      </tr>
    `;
  });

  document.getElementById("expenseTable").innerHTML = html;
}
     <script>
/* ============================================================
   GLOBAL STORAGE
============================================================ */
let attendeesData = [];
let expenseData = [];
let charts = {};
let lastLoadedData = null;

/* ============================================================
   TAB SWITCHING
============================================================ */
function openTab(tabName) {
  document.querySelectorAll(".tab-page").forEach(t => t.style.display = "none");
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

  document.getElementById(tabName).style.display = "block";
  [...document.querySelectorAll(".tab-btn")].find(btn =>
    btn.textContent.toLowerCase().includes(tabName)
  ).classList.add("active");

  if (tabName === "people") renderPeopleTable(attendeesData);
  if (tabName === "roi") renderROI();
}

/* ============================================================
   FETCH DATA FROM CLOUDFLARE WORKER
============================================================ */
async function loadData() {
  try {
    const res = await fetch("https://novevent-report-worker.ashishoct34.workers.dev/");
    const json = await res.json();

    attendeesData = json.attendees || [];
    expenseData   = json.expenses || [];

    renderCards();
    renderCharts();
    generateInsights();
  } 
  catch (err) {
    console.error("Error loading:", err);
  }
}
loadData();

/* ============================================================
   HELPERS
============================================================ */
function pct(v, total) {
  if (!total) return "0%";
  return ((v / total) * 100).toFixed(1) + "%";
}

function groupCount(data, field) {
  const map = {};
  data.forEach(x => {
    const key = (x[field] || "").trim();
    if (!key) return;
    map[key] = (map[key] || 0) + 1;
  });
  return map;
}

/* ============================================================
   CARDS RENDER + CLICK FILTER
============================================================ */
function renderCards() {
  const total = attendeesData.length;

  const lost       = attendeesData.filter(x => x.Status?.toLowerCase()=="lost").length;
  const warm       = attendeesData.filter(x => x.Status?.toLowerCase()=="warm").length;
  const cold       = attendeesData.filter(x => x.Status?.toLowerCase()=="cold").length;
  const converted  = attendeesData.filter(x => x.Status?.toLowerCase()=="converted").length;
  const unassigned = attendeesData.filter(x => !x.Assignees).length;
  const missing    = attendeesData.filter(x => !x.Status).length;

  const cardList = [
    { title:"Total Attendees", value:total, filter:()=>attendeesData },
    { title:"Lost", value:lost, sub:pct(lost,total), filter:()=>attendeesData.filter(x=>x.Status?.toLowerCase()=="lost") },
    { title:"Warm", value:warm, sub:pct(warm,total), filter:()=>attendeesData.filter(x=>x.Status?.toLowerCase()=="warm") },
    { title:"Cold", value:cold, sub:pct(cold,total), filter:()=>attendeesData.filter(x=>x.Status?.toLowerCase()=="cold") },
    { title:"Converted", value:converted, sub:pct(converted,total), filter:()=>attendeesData.filter(x=>x.Status?.toLowerCase()=="converted") },
    { title:"Unassigned", value:unassigned, filter:()=>attendeesData.filter(x=>!x.Assignees) },
    { title:"Missing Status", value:missing, filter:()=>attendeesData.filter(x=>!x.Status) }
  ];

  window.cardFilters = cardList;

  document.getElementById("cards").innerHTML = cardList.map((c,i)=>`
    <div class="card" onclick="applyCardFilter(${i})">
      <div class="card-title">${c.title}</div>
      <div class="card-value">${c.value}</div>
      ${c.sub ? `<div class="card-sub">${c.sub}</div>` : ""}
    </div>
  `).join("");
}

function applyCardFilter(i) {
  openTab("people");
  renderPeopleTable(window.cardFilters[i].filter());
}

/* ============================================================
   PEOPLE TABLE (FIXED)
============================================================ */
function renderPeopleTable(data) {
  const table = document.getElementById("peopleTable");

  if (!data || data.length === 0) {
    table.innerHTML = `<tr><td>No Data Available</td></tr>`;
    return;
  }

  const headers = Object.keys(data[0]);

  let html = "<tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr>";

  data.forEach(row => {
    html += "<tr>" + headers.map(h => `<td>${row[h] ?? ""}</td>`).join("") + "</tr>";
  });

  table.innerHTML = html;
}

function searchPeople() {
  const text = document.getElementById("searchInput").value.toLowerCase();

  const filtered = attendeesData.filter(row =>
    JSON.stringify(row).toLowerCase().includes(text)
  );

  renderPeopleTable(filtered);
}

/* ============================================================
   CHARTS — FULLY CLICKABLE + FIXED FILTERING
============================================================ */
function renderCharts() {
  const country   = groupCount(attendeesData, "Country");
  const assignees = groupCount(attendeesData, "Assignees");
  const salesRep  = groupCount(attendeesData, "Sales Rep");

  charts.country = makeBar("countryChart", country, key =>
    attendeesData.filter(x => (x.Country||"").toLowerCase()==key.toLowerCase())
  );

  charts.assignee = makeBar("assigneeChart", assignees, key =>
    attendeesData.filter(x => (x.Assignees||"").toLowerCase()==key.toLowerCase())
  );

  charts.sales = makeBar("salesChart", salesRep, key =>
    attendeesData.filter(x => (x["Sales Rep"]||"").toLowerCase()==key.toLowerCase())
  );
}

function makeBar(id, dataObj, filterFn) {
  const el = document.getElementById(id);
  if (!el) return;

  const labels = Object.keys(dataObj);
  const values = Object.values(dataObj);

  return new Chart(el, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label:"Count",
        data: values,
        backgroundColor:"#00aaff88",
        borderColor:"#33c3ff",
        borderWidth:2
      }]
    },
    options:{
      onClick:(evt, items)=>{
        if(items.length){
          const i = items[0].index;
          openTab("people");
          renderPeopleTable(filterFn(labels[i]));
        }
      },
      plugins:{ legend:{ labels:{ color:"#9ec5ff" } } },
      scales:{
        x:{ ticks:{ color:"#9ec5ff" } },
        y:{ ticks:{ color:"#9ec5ff" } }
      }
    }
  });
}

/* ============================================================
   INSIGHTS — RESTORED FULL AI STYLE
============================================================ */
function generateInsights() {
  const total      = attendeesData.length;
  const lost       = attendeesData.filter(x=>x.Status?.toLowerCase()=="lost").length;
  const warm       = attendeesData.filter(x=>x.Status?.toLowerCase()=="warm").length;
  const cold       = attendeesData.filter(x=>x.Status?.toLowerCase()=="cold").length;
  const converted  = attendeesData.filter(x=>x.Status?.toLowerCase()=="converted").length;

  document.getElementById("insightBox").innerHTML = `
    <b>Overall Summary</b><br><br>
    A total of <b>${total}</b> attendees participated in the event. 
    Out of them, <b>${pct(warm,total)}</b> are warm prospects showing high potential, while 
    <b>${pct(cold,total)}</b> fall under cold leads needing more nurturing. 
    <b>${pct(lost,total)}</b> were lost, indicating follow-up consistency issues. <br><br>
    The event successfully converted <b>${converted}</b> candidates. 
    Trends show strong interest in Australia, Germany, and UK pathways.
  `;
}

/* ============================================================
   ROI PAGE — FIXED + ENHANCED ANALYSIS
============================================================ */
function renderROI() {

  if (!expenseData || expenseData.length === 0) {
    document.getElementById("roiCards").innerHTML =
      "<div class='roi-card'>No expense data found.</div>";
    return;
  }

  const totalExpense = expenseData.reduce((sum, x) => sum + (+x.Amount || 0), 0);
  const totalAtt     = attendeesData.length;
  const converted    = attendeesData.filter(x => (x.Status || "").toLowerCase() === "converted").length;

  /* CARDS */
  document.getElementById("roiCards").innerHTML = `
    <div class="roi-card">
      <div class="roi-title">Total Expense</div>
      <div class="roi-value">Rs. ${totalExpense.toLocaleString()}</div>
    </div>

    <div class="roi-card">
      <div class="roi-title">Cost Per Attendee</div>
      <div class="roi-value">Rs. ${(totalExpense / totalAtt).toFixed(2)}</div>
    </div>

    <div class="roi-card">
      <div class="roi-title">Cost Per Converted Lead</div>
      <div class="roi-value">
        ${converted===0 ? "No converted leads"
          : "Rs. " + (totalExpense / converted).toFixed(2)}
      </div>
    </div>

    <div class="roi-card">
      <div class="roi-title">ROI Score</div>
      <div class="roi-value">
        ${(totalAtt / totalExpense).toFixed(2)} attendees per Rs.1
      </div>
    </div>
  `;

  /* TABLE */
  let html = `
    <tr>
      <th>Description</th>
      <th>Amount</th>
      <th>% of Total</th>
    </tr>
  `;

  expenseData.forEach(row => {
    html += `
      <tr>
        <td>${row.Description}</td>
        <td>Rs. ${(+row.Amount).toLocaleString()}</td>
        <td>${pct(row.Amount, totalExpense)}</td>
      </tr>
    `;
  });

  document.getElementById("expenseTable").innerHTML = html;
}
</script>

