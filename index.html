<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>November 2025 Event Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* DARK NEON THEME */
body {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  background: #050A1F;
  color: #E6EEFF;
}

/* HEADER */
.header {
  text-align: center;
  padding: 28px 10px 10px;
  background: rgba(0,0,0,0.25);
  border-bottom: 1px solid #0d1a40;
  box-shadow: 0 0 25px #002a80 inset;
}
.header-title {
  font-size: 36px;
  font-weight: 700;
  color: #9EC5FF;
  text-shadow: 0 0 12px #007bff;
}
.header-sub {
  margin-top: 4px;
  font-size: 14px;
  color: #89b6ff;
}
.header-sync {
  margin-top: 10px;
  background: #081a3a;
  display: inline-block;
  padding: 6px 16px;
  border-radius: 30px;
  border: 1px solid #0044ff;
  color: #bfe0ff;
  font-size: 13px;
  box-shadow: 0 0 10px #0044ff;
}
.header-sync::before {
  content: "● ";
  color: #00ff66;
}

/* TABS */
.tab-container {
  display: flex;
  padding: 12px;
  background: #081233;
  border-bottom: 1px solid #0F2257;
  justify-content: center;
}
.tab-btn {
  padding: 10px 20px;
  margin: 0 8px;
  background: #0D1A44;
  color: #9EC5FF;
  border: 1px solid #1D3C76;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}
.tab-btn:hover {
  background: #11245D;
}
.tab-btn.active {
  background: #0F2E7A;
  border: 1px solid #3A7DFF;
  box-shadow: 0 0 20px #0044ff;
  color: #fff;
}
.tab-page { display: none; }

/* CARDS */
#cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 18px;
  padding: 20px;
}
.card {
  padding: 18px;
  background: #0C153C;
  border: 1px solid #1F2A72;
  border-radius: 12px;
  cursor: pointer;
  transition: 0.2s;
  box-shadow: 0 0 12px #001a33 inset;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0 16px #1E90FF;
}
.card-title { font-size: 16px; color: #8DBBFF; }
.card-value { font-size: 34px; font-weight: bold; color: #fff; text-shadow: 0 0 12px #009DFF; }
.card-sub { font-size: 14px; color: #7FD2FF; margin-top: 4px; }

/* CHARTS */
.chart-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
  padding: 20px;
}
.chart-box {
  padding: 20px;
  background: #0C153C;
  border-radius: 12px;
  border: 1px solid #1D2F70;
  box-shadow: 0 0 12px #001a33 inset;
}
.chart-box h3 {
  color: #7AB8FF;
  text-shadow: 0 0 8px #008cff;
}

/* INSIGHTS */
.insight-box {
  padding: 20px;
  background: #0C153C;
  border: 1px solid #1D2F70;
  border-radius: 12px;
  box-shadow: 0 0 15px #003366;
  color: #bcd9ff;
  line-height: 1.7;
}
.insight-title {
  text-align: center;
  font-size: 22px;
  font-weight: 600;
  color: #85baff;
  text-shadow: 0 0 8px #0077ff;
  margin-bottom: 16px;
}

/* PEOPLE TABLE */
#peopleSearch {
  width: 60%;
  padding: 10px;
  margin: 20px;
  border-radius: 8px;
  border: 1px solid #1E3A7A;
  background: #0A1438;
  color: #A8CEFF;
}
.table-box { padding: 0 20px 20px; }

table {
  width: 100%;
  border-collapse: collapse;
  background: #0C153C;
  border: 1px solid #1C3B7A;
}
th {
  background: #102258;
  padding: 10px;
  color: #A8CEFF;
}
td {
  padding: 10px;
  border-bottom: 1px solid #1C3B7A;
  color: #DFE8FF;
}
tr:hover { background: #101A44; }

/* ROI PAGE */
#roiCards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap: 18px;
  padding: 20px;
}
.roi-card {
  background: #0C153C;
  padding: 18px;
  border-radius: 12px;
  border: 1px solid #1F2A72;
  box-shadow: 0 0 12px #001933 inset;
}
.roi-title { font-size: 16px; color: #8DBBFF; }
.roi-value { font-size: 28px; color: #fff; margin-top: 6px; text-shadow: 0 0 10px #00B2FF; }

</style>
</head>

<body>

<!-- === TITLE EXACTLY AS YOUR SCREENSHOT === -->
<div class="header">
  <div class="header-title">November 2025 Event Dashboard</div>
  <div class="header-sub">Premium Glass Neon Edition · Live Google Sheet Sync</div>
  <div class="header-sync">LIVE DATA FEED — CLOUDFLARE WORKER SYNC</div>

</div>

<!-- TABS -->
<div class="tab-container">
  <div class="tab-btn active" onclick="openTab('overview')">Overview</div>
  <div class="tab-btn" onclick="openTab('people')">Attendees Detail</div>
  <div class="tab-btn" onclick="openTab('roi')">ROI Analysis</div>
  <div class="tab-btn" onclick="openTab('sales')">Sales Update</div>
</div>

<!-- OVERVIEW -->
<div id="overview" class="tab-page" style="display:block;">
  <h2 style="padding-left:20px;color:#7AB8FF;">Overview Analytics</h2>
  <div id="cards"></div>

  <div class="chart-row">
    <div class="chart-box">
      <h3>Attendees by Country</h3>
      <canvas id="countryChart"></canvas>
    </div>

    <div class="insight-box">
      <div class="insight-title">EVENT INSIGHTS — AUTO GENERATED</div>
      <div id="insightText">Loading...</div>
    </div>
  </div>

  <div class="chart-row">
    <div class="chart-box">
      <h3>By Assignees</h3>
      <canvas id="assigneeChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>By Sales Rep</h3>
      <canvas id="salesChart"></canvas>
    </div>
  </div>
</div>

<!-- PEOPLE PAGE -->
<div id="people" class="tab-page">
  <h2 style="padding-left:20px;color:#7AB8FF;">Attendees Detail</h2>
  <input id="peopleSearch" type="text" placeholder="Search attendees..." onkeyup="searchPeople()" />
  <div class="table-box">
    <table id="peopleTable"></table>
  </div>
</div>

<!-- SALES UPDATE TAB -->
<div id="sales" class="tab-page">
  <h2 style="padding-left:20px;color:#7AB8FF;">Sales Update</h2>

  <!-- SALES SUMMARY CARDS -->
  <div id="salesCards" style="padding:20px;"></div>

  <!-- TWO CHARTS -->
  <div class="chart-row">
    <div class="chart-box">
      <h3>By Sales Rep</h3>
      <canvas id="salesRepChart"></canvas>
    </div>

    <div class="chart-box">
      <h3>Converted Status Breakdown</h3>
      <canvas id="convertedStageChart"></canvas>
    </div>
  </div>

  <!-- TABLE OF CONVERTED LEADS -->
  <div class="table-box" style="margin:20px;">
    <h3 style="color:#7AB8FF;">Converted Leads Detail</h3>
    <table id="salesTable"></table>
  </div>
</div>


<!-- ROI -->
<div id="roi" class="tab-page">
  <h2 style="padding-left:20px;color:#7AB8FF;">ROI & Spend Analysis</h2>
  <div id="roiCards"></div>

  <div class="chart-box" style="margin:20px;">
    <h3>Expense Breakdown</h3>
    <table id="expenseTable"></table>
  </div>
</div>

<script>
let attendeesData = [];
let fullList = [];
let metrics = {};
let expenses = [];

/* TAB SWITCH */
function openTab(tab) {
  document.querySelectorAll(".tab-page").forEach(t => t.style.display = "none");
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById(tab).style.display = "block";
  [...document.querySelectorAll(".tab-btn")]
    .find(x => x.textContent.toLowerCase().includes(tab))
    ?.classList.add("active");

  if (tab === "people") renderPeopleTable(attendeesData);
  if (tab === "sales") renderSalesTab();

}

/* LOAD DATA */
async function loadData() {
  const url = "https://novevent-report-worker.ashishoct34.workers.dev/";
  const res = await fetch(url);
  const json = await res.json();

  attendeesData = json.attendees;
  fullList = [...attendeesData];
  metrics = json.metrics;
  expenses = json.expenses || [];

  renderCards();
  renderCharts();
  renderAutoInsights();
  renderROICards();
  renderExpenseTable();
}
loadData();

/* HELPERS */
function pct(v, total) {
  if (!total) return "0%";
  return ((v / total) * 100).toFixed(1) + "%";
}

/* CARDS */
function renderCards() {
  const total = metrics.totalAttendees;
  const lost = metrics.lost;
  const warm = metrics.warm;
  const cold = metrics.cold;
  const converted = attendeesData.filter(x => (x.Status || "").toLowerCase() === "converted").length;

  const data = [
    { t: "Total Attendees", v: total, f: () => attendeesData },
    { t: "Lost", v: lost, sub:pct(lost,total), f: () => attendeesData.filter(x => (x.Status||"").toLowerCase()==="lost") },
    { t: "Warm", v: warm, sub:pct(warm,total), f: () => attendeesData.filter(x => (x.Status||"").toLowerCase()==="warm") },
    { t: "Cold", v: cold, sub:pct(cold,total), f: () => attendeesData.filter(x => (x.Status||"").toLowerCase()==="cold") },
    { t: "Converted", v: converted, sub:pct(converted,total), f: () => attendeesData.filter(x => (x.Status||"").toLowerCase()==="converted") },
    { t: "Unassigned", v: metrics.unassigned, f: () => attendeesData.filter(x => !x.Assignees) },
    { t: "Missing Status", v: metrics.missingStatus, f: () => attendeesData.filter(x => !x.Status) },
  ];

  window.cardFilters = data;

  document.getElementById("cards").innerHTML = data.map((c,i)=>`
    <div class="card" onclick="applyFilter(${i})">
      <div class="card-title">${c.t}</div>
      <div class="card-value">${c.v}</div>
      ${c.sub ? `<div class="card-sub">${c.sub}</div>` : ""}
    </div>
  `).join("");
}

function applyFilter(i) {
  openTab("people");
  renderPeopleTable(window.cardFilters[i].f());
}

/* PEOPLE TABLE */
function renderPeopleTable(list) {
  if (!list || list.length === 0) {
    document.getElementById("peopleTable").innerHTML = "<tr><td>No Data</td></tr>";
    return;
  }

  const headers = Object.keys(list[0]);
  let html = "<tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr>";

  list.forEach(row => {
    html += "<tr>" + headers.map(h=>`<td>${row[h]||""}</td>`).join("") + "</tr>";
  });

  document.getElementById("peopleTable").innerHTML = html;
}

function searchPeople() {
  const q = document.getElementById("peopleSearch").value.toLowerCase();
  const filtered = fullList.filter(row =>
    Object.values(row).some(v => (v + "").toLowerCase().includes(q))
  );
  renderPeopleTable(filtered);
}

/* GROUPING */
function groupCount(arr, field) {
  const map = {};
  arr.forEach(x => {
    const key = (x[field] || "").trim();
    if (!key) return;
    map[key] = (map[key] || 0) + 1;
  });
  return map;
}

/* CHARTS */
function makeChart(id, dataObj, filterFn) {
  const labels = Object.keys(dataObj);
  const values = Object.values(dataObj);

  return new Chart(document.getElementById(id), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label:"Count",
        data: values,
        backgroundColor:"#00aaff88",
        borderColor:"#33c3ff",
        borderWidth:2
      }]
    },
    options:{
      onClick:(evt, items)=>{
        if(items.length){
          const key = labels[items[0].index];
          openTab("people");
          renderPeopleTable(filterFn(key));
        }
      },
      scales:{
        x:{ ticks:{ color:"#9ec5ff" } },
        y:{ ticks:{ color:"#9ec5ff" } }
      }
    }
  });
}

function renderCharts() {
  makeChart("countryChart",
    groupCount(attendeesData, "Country"),
    (key)=> attendeesData.filter(x => (x.Country||"").toLowerCase() === key.toLowerCase())
  );

  makeChart("assigneeChart",
    groupCount(attendeesData, "Assignees"),
    (key)=> attendeesData.filter(x => (x.Assignees||"").toLowerCase() === key.toLowerCase())
  );

  makeChart("salesChart",
    groupCount(attendeesData, "Sales Rep"),
    (key)=> attendeesData.filter(x => (x["Sales Rep"]||"").toLowerCase() === key.toLowerCase())
  );
}

/* ====== AUTO INSIGHTS (Like Your Screenshot) ====== */
function renderAutoInsights() {
  const t = attendeesData.length;
  if (!t) return;

  const countryMap = groupCount(attendeesData, "Country");
  const assigneeMap = groupCount(attendeesData, "Assignees");
  const salesMap = groupCount(attendeesData, "Sales Rep");

  const topCountry = Object.entries(countryMap).sort((a,b)=>b[1]-a[1])[0];
  const topAssignee = Object.entries(assigneeMap).sort((a,b)=>b[1]-a[1])[0];
  const topSalesRep = Object.entries(salesMap).sort((a,b)=>b[1]-a[1])[0];

  const lost = metrics.lost;
  const warm = metrics.warm;
  const cold = metrics.cold;

  const insights = `
    <p><b>1. Geographic Reach & Market Momentum</b><br>
       ${topCountry ? `${topCountry[0]} recorded the highest turnout with ${topCountry[1]} attendees, indicating stronger traction in that region.` : "Country data unavailable."}
    </p>

    <p><b>2. Lead Quality & Engagement Flow</b><br>
       Lost leads account for <b>${pct(lost,t)}</b>. Warm leads stand at <b>${pct(warm,t)}</b>, suggesting strong nurturing potential, while cold leads at <b>${pct(cold,t)}</b> show re-engagement opportunities.
    </p>

    <p><b>3. Assignee Load Distribution</b><br>
       ${topAssignee ? `${topAssignee[0]} handled ${topAssignee[1]} assignments, the highest among the team. A more even spread could improve quality and response time.` : "No assignee data available."}
    </p>

    <p><b>4. Sales Rep Engagement</b><br>
       ${topSalesRep ? `${topSalesRep[0]} completed the most follow-ups (${topSalesRep[1]}), showing higher lead ownership and engagement.` : "No sales rep activity detected."}
    </p>

    <p><b>5. Strategic Takeaways</b><br>
       Balancing workload, improving warm-lead follow-ups, and boosting rep engagement can significantly increase conversions and overall event ROI.
    </p>
  `;

  document.getElementById("insightText").innerHTML = insights;
}

/* ROI CARDS */
function renderROICards() {
  const totalExp = metrics.totalExpense;
  const total = metrics.totalAttendees;

  const converted = attendeesData.filter(
    x => (x.Status||"").toLowerCase()==="converted"
  ).length;

  const cpa = total ? totalExp / total : 0;
  const cpc = converted ? totalExp / converted : 0;

  const cards = [
    { t:"Total Expense", v:"Rs. "+totalExp.toLocaleString() },
    { t:"Cost Per Attendee", v:"Rs. "+cpa.toFixed(2) },
    { t:"Cost Per Converted", v: converted ? ("Rs. "+cpc.toFixed(2)) : "No converted leads" }
  ];

  document.getElementById("roiCards").innerHTML = cards.map(c => `
    <div class="roi-card">
      <div class="roi-title">${c.t}</div>
      <div class="roi-value">${c.v}</div>
    </div>
  `).join("");
}

/* EXPENSE TABLE */
function renderExpenseTable() {
  if (!expenses.length){
    document.getElementById("expenseTable").innerHTML = "<tr><td>No Expense Data</td></tr>";
    return;
  }

  const total = expenses.reduce((s,r)=>s+r.Amount,0);

  let html = `<tr><th>Description</th><th>Amount</th><th>% of Total</th></tr>`;

  expenses.forEach(e=>{
    html += `
      <tr>
        <td>${e.Description}</td>
        <td>Rs. ${e.Amount.toLocaleString()}</td>
        <td>${pct(e.Amount,total)}</td>
      </tr>
    `;
  });

  document.getElementById("expenseTable").innerHTML = html;
}
 /* ====== SALES UPDATE TAB ====== */

function getConvertedLeads() {
  return attendeesData.filter(
    x => (x.Status || "").toLowerCase() === "converted"
  );
}

function getAssignedLeads(list) {
  return list.filter(
    x => (x["Sales Rep"] || "").trim() !== ""
  );
}

function renderSalesTab() {
  const converted = getConvertedLeads();
  const assigned = getAssignedLeads(converted);

  /* ===== CARDS ===== */
  document.getElementById("salesCards").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;">

      <div class="card" onclick="openConverted()">
        <div class="card-title">Total Converted</div>
        <div class="card-value">${converted.length}</div>
      </div>

      <div class="card" onclick="openAssigned()">
        <div class="card-title">Assigned to Sales Rep</div>
        <div class="card-value">${assigned.length}</div>
      </div>

    </div>
  `;

  /* ===== CHARTS ===== */
  renderSalesRepChart(assigned);
  renderConvertedStageChart(converted);

  /* ===== TABLE ===== */
  renderSalesTable(converted);
}

/* ===== CLICK HANDLERS ===== */
function openConverted() {
  openTab("people");
  renderPeopleTable(getConvertedLeads());
}

function openAssigned() {
  openTab("people");
  renderPeopleTable(getAssignedLeads(getConvertedLeads()));
}

/* ===== SALES REP CHART ===== */
function renderSalesRepChart(list) {
  const map = groupCount(list, "Sales Rep");

  new Chart(document.getElementById("salesRepChart"), {
    type: "bar",
    data: {
      labels: Object.keys(map),
      datasets: [{
        label: "Assigned Leads",
        data: Object.values(map),
        backgroundColor: "#00b0ff88",
        borderColor: "#00c2ff",
        borderWidth: 2
      }]
    },
    options: {
      onClick: (evt, items) => {
        if (items.length) {
          const rep = Object.keys(map)[items[0].index];
          openTab("people");
          renderPeopleTable(
            getConvertedLeads().filter(
              x => (x["Sales Rep"] || "").toLowerCase() === rep.toLowerCase()
            )
          );
        }
      },
      scales: {
        x: { ticks: { color: "#9ec5ff" } },
        y: { ticks: { color: "#9ec5ff" } }
      }
    }
  });
}
  function makeSalesRepChart() {
  const converted = getConvertedLeads();
  const assigned = getAssignedLeads(converted);
  const map = groupCount(assigned, "Sales Rep");

  return {
    labels: Object.keys(map),
    values: Object.values(map)
  };
}


/* ===== CONVERTED STATUS CHART ===== */
function renderConvertedStageChart(list) {
  const map = groupCount(list, "converted status");

  new Chart(document.getElementById("convertedStageChart"), {
    type: "bar",
    data: {
      labels: Object.keys(map),
      datasets: [{
        label: "Count",
        data: Object.values(map),
        backgroundColor: "#29b6f6aa",
        borderColor: "#29b6f6",
        borderWidth: 2
      }]
    },
    options: {
      onClick: (evt, items) => {
        if (items.length) {
          const stage = Object.keys(map)[items[0].index];
          openTab("people");
          renderPeopleTable(
            getConvertedLeads().filter(
              x => (x["converted status"] || "").toLowerCase() === stage.toLowerCase()
            )
          );
        }
      },
      scales: {
        x: { ticks: { color: "#9ec5ff" } },
        y: { ticks: { color: "#9ec5ff" } }
      }
    }
  });
}


function renderSalesTable(list) {
  if (!list.length) {
    document.getElementById("salesTable").innerHTML = "<tr><td>No Converted Leads</td></tr>";
    return;
  }

  const headers = Object.keys(list[0]);

  let html = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  list.forEach(row => {
    html += "<tr>" + headers.map(h => `<td>${row[h] || ""}</td>`).join("") + "</tr>";
  });

  document.getElementById("salesTable").innerHTML = html;
}
</script>

</body>
</html>
