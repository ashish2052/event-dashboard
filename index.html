<script>
// ==========================
// GLOBAL
// ==========================
let attendeesData = [];
let expenseData = [];

// ==========================
// TABS
// ==========================
function openTab(tab) {
  document.querySelectorAll(".tab-page").forEach(p => p.style.display = "none");
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

  document.getElementById(tab).style.display = "block";
  document.querySelectorAll(".tab-btn").forEach(b => {
    if (b.textContent.toLowerCase().includes(tab)) b.classList.add("active");
  });

  if (tab === "people") renderPeopleTable(attendeesData);
  if (tab === "roi") renderROI();
}

// ==========================
// FETCH DATA
// ==========================
async function loadData() {
  try {
    const res = await fetch("https://novevent-report-worker.ashishoct34.workers.dev/");
    const json = await res.json();

    attendeesData = json.attendees || [];
    expenseData = json.expenses || [];

    renderCards();
    renderCharts();
    generateInsights();

  } catch (e) {
    console.log("ERROR loading data", e);
  }
}
loadData();

// ==========================
// HELPERS
// ==========================
function pct(v, total) {
  return total ? ((v / total) * 100).toFixed(1) + "%" : "0%";
}

// ==========================
// CARDS
// ==========================
function renderCards() {
  const total = attendeesData.length;

  const lost = attendeesData.filter(x => x.Status?.toLowerCase() === "lost").length;
  const warm = attendeesData.filter(x => x.Status?.toLowerCase() === "warm").length;
  const cold = attendeesData.filter(x => x.Status?.toLowerCase() === "cold").length;
  const conv = attendeesData.filter(x => x.Status?.toLowerCase() === "converted").length;
  const unassigned = attendeesData.filter(x => !x.Assignees).length;
  const missing = attendeesData.filter(x => !x.Status).length;

  const cards = [
    { title: "Total Attendees", value: total, sub: "", filter: () => attendeesData },
    { title: "Lost", value: lost, sub: pct(lost,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "lost") },
    { title: "Warm", value: warm, sub: pct(warm,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "warm") },
    { title: "Cold", value: cold, sub: pct(cold,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "cold") },
    { title: "Converted", value: conv, sub: pct(conv,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "converted") },
    { title: "Unassigned", value: unassigned, sub: "", filter: () => attendeesData.filter(x => !x.Assignees) },
    { title: "Missing Status", value: missing, sub: "", filter: () => attendeesData.filter(x => !x.Status) }
  ];

  window.cardFilters = cards;

  document.getElementById("cards").innerHTML = cards.map((c,i)=>`
    <div class="card" onclick="applyCardFilter(${i})">
      <div class="card-title">${c.title}</div>
      <div class="card-value">${c.value}</div>
      ${c.sub ? `<div class="card-sub">${c.sub}</div>` : ""}
    </div>
  `).join("");
}

function applyCardFilter(i) {
  const filtered = window.cardFilters[i].filter();
  openTab("people");
  renderPeopleTable(filtered);
}

// ==========================
// PEOPLE TABLE
// ==========================
function renderPeopleTable(data) {
  if (!data.length) {
    document.getElementById("peopleTable").innerHTML = "<tr><td>No Data Available</td></tr>";
    return;
  }

  const headers = Object.keys(data[0]);

  let html = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  data.forEach(row => {
    html += "<tr>" + headers.map(h => `<td>${row[h] || ""}</td>`).join("") + "</tr>";
  });

  document.getElementById("peopleTable").innerHTML = html;
}

function searchPeople() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const filtered = attendeesData.filter(r =>
    JSON.stringify(r).toLowerCase().includes(q)
  );
  renderPeopleTable(filtered);
}

// ==========================
// GROUP COUNTS
// ==========================
function groupCount(data, field) {
  const m = {};
  data.forEach(x => {
    const key = (x[field] || "").trim();
    if (key) m[key] = (m[key] || 0) + 1;
  });
  return m;
}

// ==========================
// CHARTS
// ==========================
function renderCharts() {
  makeBar("countryChart", "Country");
  makeBar("assigneeChart", "Assignees");
  makeBar("salesChart", "Sales Rep");
}

function makeBar(canvasId, field) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return;

  const obj = groupCount(attendeesData, field);
  const labels = Object.keys(obj);
  const values = Object.values(obj);

  new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Count",
        data: values,
        backgroundColor: "#00aaff88",
        borderColor: "#33c3ff",
        borderWidth: 1.5
      }]
    },
    options: {
      onClick: (e, items) => {
        if (items.length) {
          const key = labels[items[0].index];
          const filtered = attendeesData.filter(x =>
            (x[field] || "").toLowerCase() === key.toLowerCase()
          );
          openTab("people");
          renderPeopleTable(filtered);
        }
      },
      plugins: { legend: { labels: { color: "#9ec5ff" } } },
      scales: {
        x: { ticks: { color: "#9ec5ff" } },
        y: { ticks: { color: "#9ec5ff" } }
      }
    }
  });
}

// ==========================
// INSIGHTS
// ==========================
function generateInsights() {
  const total = attendeesData.length;
  const warm = attendeesData.filter(x => x.Status?.toLowerCase() === "warm").length;
  const cold = attendeesData.filter(x => x.Status?.toLowerCase() === "cold").length;
  const lost = attendeesData.filter(x => x.Status?.toLowerCase() === "lost").length;
  const conv = attendeesData.filter(x => x.Status?.toLowerCase() === "converted").length;

  document.getElementById("insightBox").innerHTML = `
    Total attendees recorded: <b>${total}</b><br><br>
    Warm: <b>${warm}</b> (${pct(warm,total)})<br>
    Cold: <b>${cold}</b> (${pct(cold,total)})<br>
    Lost: <b>${lost}</b> (${pct(lost,total)})<br><br>
    Converted leads: <b>${conv}</b> (${pct(conv,total)}).
  `;
}

// ==========================
// ROI
// ==========================
function renderROI() {

  if (!expenseData.length) {
    document.getElementById("roiCards").innerHTML = "<div class='roi-card'>No expense data found.</div>";
    return;
  }

  const totalExp = expenseData.reduce((s,r)=> s + (parseFloat(r.Amount)||0),0);
  const totalAtt = attendeesData.length;
  const conv = attendeesData.filter(x => x.Status?.toLowerCase() === "converted").length;

  document.getElementById("roiCards").innerHTML = `
    <div class="roi-card"><div class="roi-title">Total Expense</div><div class="roi-value">Rs. ${totalExp.toLocaleString()}</div></div>
    <div class="roi-card"><div class="roi-title">Cost Per Attendee</div><div class="roi-value">Rs. ${(totalExp/totalAtt).toFixed(2)}</div></div>
    <div class="roi-card"><div class="roi-title">Cost Per Converted</div><div class="roi-value">${conv? "Rs. "+(totalExp/conv).toFixed(2) :"No converted leads"}</div></div>
    <div class="roi-card"><div class="roi-title">ROI Score</div><div class="roi-value">${((totalAtt/totalExp)*100).toFixed(1)} per 100 Rs</div></div>
  `;

  let rows = `
    <tr><th>Description</th><th>Amount</th><th>%</th></tr>
  `;

  expenseData.forEach(r=>{
    const amt = parseFloat(r.Amount)||0;
    rows += `
      <tr>
        <td>${r.Description}</td>
        <td>Rs. ${amt.toLocaleString()}</td>
        <td>${pct(amt,totalExp)}</td>
      </tr>
    `;
  });

  document.getElementById("expenseTable").innerHTML = rows;
}

</script>
<body>

<!-- ===========================
       HEADER
=========================== -->
<div class="header">
  <div class="header-title">November 2025 Event Dashboard</div>
  <div class="header-sub">Premium Glass Neon Edition · Live Google Sheet Sync</div>

  <div class="live-box">
    <div class="live-dot"></div>
    LIVE DATA FEED — CLOUDFLARE WORKER SYNC
  </div>
</div>

<!-- ===========================
       NAVIGATION TABS
=========================== -->
<div class="tab-container">
  <div class="tab-btn active" onclick="openTab('overview')">Overview</div>
  <div class="tab-btn" onclick="openTab('people')">Attendees Detail</div>
  <div class="tab-btn" onclick="openTab('roi')">ROI Analysis</div>
</div>

<!-- ===========================
       OVERVIEW PAGE
=========================== -->
<div id="overview" class="tab-page" style="display:block;">

  <h2 class="section-title">Overview Analytics</h2>

  <div id="cards" class="card-grid"></div>

  <!-- ===========================
         ROW 1 (Country + Insights)
  ============================ -->
  <div class="analytics-row" style="display:flex;gap:25px;flex-wrap:wrap;padding:0 20px;">

    <!-- CHART: COUNTRY -->
    <div class="chart-box" style="flex:1;min-width:420px;">
      <h3>Attendees by Country</h3>
      <canvas id="countryChart" height="180"></canvas>
    </div>

    <!-- INSIGHTS -->
    <div class="insight-box" id="insightBox" style="flex:1;min-width:420px;">
      Loading insights...
    </div>

  </div>

  <!-- ===========================
         ROW 2 (Assignee + Sales)
  ============================ -->
  <div class="analytics-row" style="display:flex;gap:25px;flex-wrap:wrap;padding:20px;">

    <!-- CHART: ASSIGNEES -->
    <div class="chart-box" style="flex:1;min-width:420px;">
      <h3>By Assignees</h3>
      <canvas id="assigneeChart" height="180"></canvas>
    </div>

    <!-- CHART: SALES REP -->
    <div class="chart-box" style="flex:1;min-width:420px;">
      <h3>By Sales Rep</h3>
      <canvas id="salesChart" height="180"></canvas>
    </div>

  </div>

</div>

<!-- ===========================
       ATTENDEES DETAIL PAGE
=========================== -->
<div id="people" class="tab-page">

  <h2 class="section-title">Attendees Detail</h2>

  <input
    type="text"
    id="searchInput"
    class="search-box"
    onkeyup="searchPeople()"
    placeholder="Search attendees..."
  />

  <div style="padding:20px;">
    <table id="peopleTable"></table>
  </div>

</div>

<!-- ===========================
       ROI PAGE
=========================== -->
<div id="roi" class="tab-page">

  <h2 class="section-title">ROI & Spend Analysis</h2>

  <!-- ROI CARDS -->
  <div class="roi-card-grid" id="roiCards"></div>

  <!-- PIE CHART -->
  <div class="chart-box" style="margin:20px;">
    <h3>Expense Distribution</h3>
    <canvas id="expensePieChart"></canvas>
  </div>

  <!-- EXPENSE TABLE -->
  <div class="chart-box" style="margin:20px;">
    <h3>Expense Breakdown</h3>
    <table id="expenseTable"></table>
  </div>

</div>

</body>
<script>
// ======================================================
//  GLOBAL VARIABLES
// ======================================================
let attendeesData = [];
let expenseData = [];
let metrics = {};

// ======================================================
//  TAB SWITCHING
// ======================================================
function openTab(tabName) {
  document.querySelectorAll(".tab-page").forEach(t => t.style.display = "none");
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

  document.getElementById(tabName).style.display = "block";

  [...document.querySelectorAll(".tab-btn")].find(btn =>
    btn.textContent.toLowerCase().includes(tabName)
  ).classList.add("active");

  if (tabName === "people") renderPeopleTable(attendeesData);
  if (tabName === "roi") renderROI();
}

// ======================================================
//  FETCH DATA FROM WORKER
// ======================================================
async function loadData() {
  const url = "https://novevent-report-worker.ashishoct34.workers.dev/";

  try {
    const res = await fetch(url);
    const json = await res.json();

    attendeesData = json.attendees;
    expenseData = json.expenses || [];   // LIVE Google Sheet expenses
    metrics = json.metrics;

    renderCards();
    renderCharts();
    generateInsights();

  } catch (err) {
    console.error("LOAD ERROR:", err);
  }
}

loadData();

// ======================================================
//  % FUNCTION
// ======================================================
function pct(v, total) {
  if (!total) return "0%";
  return ((v / total) * 100).toFixed(1) + "%";
}

// ======================================================
//  CARDS
// ======================================================
function renderCards() {

  const total = attendeesData.length;

  const lost = attendeesData.filter(x => x.Status?.toLowerCase() === "lost").length;
  const warm = attendeesData.filter(x => x.Status?.toLowerCase() === "warm").length;
  const cold = attendeesData.filter(x => x.Status?.toLowerCase() === "cold").length;
  const conv = attendeesData.filter(x => x.Status?.toLowerCase() === "converted").length;
  const unassigned = attendeesData.filter(x => !x.Assignees).length;
  const missing = attendeesData.filter(x => !x.Status).length;

  const cards = [
    { title: "Total Attendees", value: total, sub: "", filter: () => attendeesData },
    { title: "Lost", value: lost, sub: pct(lost,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "lost") },
    { title: "Warm", value: warm, sub: pct(warm,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "warm") },
    { title: "Cold", value: cold, sub: pct(cold,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "cold") },
    { title: "Converted", value: conv, sub: pct(conv,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "converted") },
    { title: "Unassigned", value: unassigned, sub: "", filter: () => attendeesData.filter(x => !x.Assignees) },
    { title: "Missing Status", value: missing, sub: "", filter: () => attendeesData.filter(x => !x.Status) }
  ];

  window.cardFilters = cards;

  document.getElementById("cards").innerHTML = cards.map((c,i)=>`
    <div class="card" onclick="applyCardFilter(${i})">
      <div class="card-title">${c.title}</div>
      <div class="card-value">${c.value}</div>
      ${c.sub ? `<div class="card-sub">${c.sub}</div>` : ""}
    </div>
  `).join("");
}

function applyCardFilter(i) {
  const filtered = window.cardFilters[i].filter();
  openTab("people");
  renderPeopleTable(filtered);
}

// ======================================================
//  ATTENDEES TABLE + SEARCH
// ======================================================
function renderPeopleTable(data) {
  if (!data || data.length === 0) {
    document.getElementById("peopleTable").innerHTML =
      "<tr><td>No Data Available</td></tr>";
    return;
  }

  const headers = Object.keys(data[0]);
  let html = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  data.forEach(row => {
    html += "<tr>" + headers.map(h => `<td>${row[h] || ""}</td>`).join("") + "</tr>";
  });

  document.getElementById("peopleTable").innerHTML = html;
}

function searchPeople() {
  const text = document.getElementById("searchInput").value.toLowerCase();
  const filtered = attendeesData.filter(row =>
    JSON.stringify(row).toLowerCase().includes(text)
  );
  renderPeopleTable(filtered);
}

// ======================================================
//  GROUP COUNT
// ======================================================
function groupCount(data, field) {
  const map = {};
  data.forEach(x => {
    const key = (x[field] || "").trim();
    if (!key) return;
    map[key] = (map[key] || 0) + 1;
  });
  return map;
}

// ======================================================
//  CHARTS
// ======================================================
let charts = {};

function renderCharts() {
  const country = groupCount(attendeesData, "Country");
  const assignees = groupCount(attendeesData, "Assignees");
  const sales = groupCount(attendeesData, "Sales Rep");

  charts.country = makeBarChart("countryChart", country, key =>
    attendeesData.filter(x => (x.Country || "").toLowerCase() === key.toLowerCase())
  );

  charts.assignee = makeBarChart("assigneeChart", assignees, key =>
    attendeesData.filter(x => (x.Assignees || "").toLowerCase() === key.toLowerCase())
  );

  charts.sales = makeBarChart("salesChart", sales, key =>
    attendeesData.filter(x => (x["Sales Rep"] || "").toLowerCase() === key.toLowerCase())
  );
}

// ======================================================
//  CLICKABLE BAR CHARTS
// ======================================================
function makeBarChart(id, obj, filterFn) {
  const ctx = document.getElementById(id);
  if (!ctx) return;

  const labels = Object.keys(obj);
  const values = Object.values(obj);

  return new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Count",
        data: values,
        backgroundColor: "#00aaff88",
        borderColor: "#33c3ff",
        borderWidth: 1.8
      }]
    },
    options: {
      responsive: true,
      onClick: (e, items) => {
        if (items.length > 0) {
          const index = items[0].index;
          const key = labels[index];
          const filtered = filterFn(key);

          openTab("people");
          renderPeopleTable(filtered);
        }
      },
      plugins: {
        legend: { labels: { color: "#9ec5ff" } }
      },
      scales: {
        x: { ticks: { color: "#9ec5ff" } },
        y: { ticks: { color: "#9ec5ff" } }
      }
    }
  });
}

// ======================================================
//  INSIGHTS (NEON ANALYTICS SENTENCE)
// ======================================================
function generateInsights() {
  const total = attendeesData.length;

  const warm = attendeesData.filter(x => x.Status?.toLowerCase() === "warm").length;
  const cold = attendeesData.filter(x => x.Status?.toLowerCase() === "cold").length;
  const lost = attendeesData.filter(x => x.Status?.toLowerCase() === "lost").length;
  const converted = attendeesData.filter(x => x.Status?.toLowerCase() === "converted").length;

  document.getElementById("insightBox").innerHTML = `
    A total of <b>${total}</b> attendees have been recorded so far.<br><br>

    <b>${pct(warm,total)}</b> of the leads are Warm and <b>${pct(cold,total)}</b> are Cold,<br>
    indicating the overall follow-up potential for this event.<br><br>

    Lost leads represent <b>${pct(lost,total)}</b> — a useful metric for measuring<br>
    improvement areas in next-event follow-up strategy.<br><br>

    Converted Leads: <b>${converted}</b> (${pct(converted,total)}) — strong signal of event ROI.
  `;
}

// ======================================================
//  ROI + PIE CHART
// ======================================================
function renderROI() {

  if (!expenseData || expenseData.length === 0) {
    document.getElementById("roiCards").innerHTML =
      "<div class='roi-card'>No expense data found.</div>";
    return;
  }

  const totalExpense = expenseData.reduce((sum, row) =>
    sum + (parseFloat(row.Amount) || 0), 0
  );

  const totalAtt = attendeesData.length;
  const converted = attendeesData.filter(
    x => (x.Status || "").toLowerCase() === "converted"
  ).length;

  // ROI CARDS
  document.getElementById("roiCards").innerHTML = `
    <div class="roi-card">
      <div class="roi-title">Total Expense</div>
      <div class="roi-value">Rs. ${totalExpense.toLocaleString()}</div>
    </div>

    <div class="roi-card">
      <div class="roi-title">Cost Per Attendee</div>
      <div class="roi-value">Rs. ${(totalExpense / totalAtt).toFixed(2)}</div>
    </div>

    <div class="roi-card">
      <div class="roi-title">Cost Per Converted Lead</div>
      <div class="roi-value">
        ${converted === 0 ? "No converted leads" : "Rs. " + (totalExpense / converted).toFixed(2)}
      </div>
    </div>

    <div class="roi-card">
      <div class="roi-title">ROI Score</div>
      <div class="roi-value">${((totalAtt / totalExpense) * 100).toFixed(1)} per 100 Rs</div>
    </div>
  `;

  // Expense Table
  let html = `
    <tr>
      <th>Description</th>
      <th>Amount</th>
      <th>% of Total</th>
    </tr>
  `;

  expenseData.forEach(row => {
    const amt = parseFloat(row.Amount) || 0;

    html += `
      <tr>
        <td>${row.Description}</td>
        <td>Rs. ${amt.toLocaleString()}</td>
        <td>${pct(amt,totalExpense)}</td>
      </tr>
    `;
  });

  document.getElementById("expenseTable").innerHTML = html;

  // PIE CHART
  const labels = expenseData.map(r => r.Description);
  const values = expenseData.map(r => parseFloat(r.Amount));

  new Chart(document.getElementById("expensePieChart"), {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: ["#00aaff","#0055ff","#00ffaa","#ff0066","#ffaa00","#ff5500"]
      }]
    },
    options: {
      plugins: { legend: { labels: { color: "#9ec5ff" } } }
    }
  });
}

</script>
