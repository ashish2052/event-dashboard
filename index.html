<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: #050A1F;
  color: #E6EBFF;
}

/* Top Nav */
.navbar {
  background: rgba(0,0,0,0.4);
  padding: 15px;
  text-align: center;
  font-size: 22px;
  color: #7AB8FF;
  text-shadow: 0 0 10px #00c3ff;
  border-bottom: 1px solid #0f2657;
}

/* Tabs */
.tab-container {
  display: flex;
  padding: 10px;
  background: #0A112F;
  border-bottom: 1px solid #112255;
}
.tab-btn {
  padding: 10px 18px;
  margin-right: 10px;
  background: #0E1A47;
  border: 1px solid #1C3B7A;
  border-radius: 6px;
  cursor: pointer;
  color: #9EC5FF;
  text-shadow: 0 0 10px #008cff;
}
.tab-btn.active {
  background: #112B6E;
  color: #fff;
  border: 1px solid #3A7DFF;
  box-shadow: 0 0 10px #3a7dff, 0 0 20px #0044ff;
}

/* Card Grid */
.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap: 20px;
  padding: 20px;
}

/* Cards */
.card {
  padding: 18px;
  background: #0C153C;
  border: 1px solid #1D2F70;
  border-radius: 12px;
  cursor: pointer;
  transition: 0.2s;
  box-shadow: 0 0 12px #001a33 inset;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0 10px #008cff;
}
.card-title {
  font-size: 16px;
  color: #8EBEFF;
  margin-bottom: 6px;
}
.card-value {
  font-size: 32px;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 0 10px #00aaff;
}
.card-sub {
  font-size: 13px;
  margin-top: 6px;
  color: #9fc5ff;
  text-shadow: 0 0 8px #0099ff;
}

/* CHART + INSIGHT ROW */
.analytics-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 22px;
  padding: 20px;
}

/* Chart Box */
.chart-box {
  padding: 20px;
  background: #0C153C;
  border: 1px solid #1D2F70;
  border-radius: 12px;
  box-shadow: 0 0 12px #001a33 inset;
}

/* Insights Box */
.insight-box {
  padding: 20px;
  background: #0C153C;
  border: 1px solid #1D2F70;
  border-radius: 12px;
  box-shadow: 0 0 15px #003366;
  color: #bcd9ff;
  line-height: 1.7;
}
.insight-title {
  font-size: 20px;
  color: #7AB8FF;
  margin-bottom: 15px;
  text-shadow: 0 0 8px #008cff;
}

/* DOUBLE CHART ROW */
.double-chart-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 22px;
  padding: 20px;
}

/* People Table */
.table-box {
  padding: 20px;
}
table {
  border-collapse: collapse;
  width: 100%;
  background: #0C153C;
  border: 1px solid #1C3B7A;
  color: #fff;
  font-size: 14px;
}
th, td {
  padding: 10px;
  border: 1px solid #1C3B7A;
}
th {
  background: #102258;
  color: #A8CEFF;
}
</style>

</head>
<body>

<div class="navbar">
  EVENT DASHBOARD • Real-Time Google Sheet Sync
</div>

<div class="tab-container">
  <div class="tab-btn active" onclick="openTab('overview')">Overview</div>
  <div class="tab-btn" onclick="openTab('people')">Attendees Detail</div>
</div>

<!-- OVERVIEW PAGE -->
<div id="overview" class="tab-page" style="display:block;">

  <h2 style="padding-left:20px;color:#7AB8FF;">Overview Analytics</h2>

  <!-- METRIC CARDS -->
  <div id="cards" class="card-grid"></div>

  <!-- ===== ROW 2 (Chart + Insights) ===== -->
  <div class="analytics-row">
    
    <!-- LEFT: COUNTRY CHART -->
    <div class="chart-box">
      <h3>Attendees by Country</h3>
      <canvas id="countryChart"></canvas>
    </div>

    <!-- RIGHT: INSIGHTS -->
    <div class="insight-box">
      <div class="insight-title">Event Insights — Auto Generated</div>
      <div id="insightText">Loading insights...</div>
    </div>

  </div>

  <!-- ===== ROW 3 (Assignee & Sales Charts) ===== -->
  <div class="double-chart-row">
    
    <div class="chart-box">
      <h3>Attendees by Assignees</h3>
      <canvas id="assigneeChart"></canvas>
    </div>

    <div class="chart-box">
      <h3>Attendees by Sales Rep</h3>
      <canvas id="salesChart"></canvas>
    </div>

  </div>

</div>

<!-- PEOPLE PAGE -->
<div id="people" class="tab-page" style="display:none;">
  <h2 style="padding-left:20px;color:#7AB8FF;">Attendees Detail</h2>
  <div class="table-box">
    <div id="peopleTableWrapper">
      <table id="peopleTable"></table>
    </div>
  </div>
</div>
  <script>
let attendeesData = [];
let allMetrics = {};

// =========================
//        TAB SWITCH
// =========================
function openTab(tab) {
  document.querySelectorAll('.tab-page').forEach(x => x.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));

  document.getElementById(tab).style.display = 'block';
  [...document.querySelectorAll('.tab-btn')]
    .find(btn => btn.textContent.toLowerCase().includes(tab))
    .classList.add('active');

  if (tab === 'people') renderPeopleTable(attendeesData);
}

// =========================
//    LOAD WORKER DATA
// =========================
async function loadData() {
  const url = "https://novevent-report-worker.ashishoct34.workers.dev/";

  const res = await fetch(url);
  const json = await res.json();

  attendeesData = json.attendees;
  allMetrics = json.metrics;

  renderCards();
  renderCharts();
  renderInsights();
}

loadData();

// =========================
//        CARDS
// =========================
function renderCards() {
  const total = allMetrics.totalAttendees;
  const lost = allMetrics.lost;
  const warm = allMetrics.warm;
  const cold = allMetrics.cold;
  const converted = attendeesData.filter(x => (x.Status || "").toLowerCase() === "converted").length;
  const totalExpense = allMetrics.totalExpense || 0;

  const cards = [
    { title: "Total Attendees", value: total, filter: () => attendeesData },
    { title: "Lost", value: lost, sub: pct(lost,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "lost") },
    { title: "Warm", value: warm, sub: pct(warm,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "warm") },
    { title: "Cold", value: cold, sub: pct(cold,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "cold") },
    { title: "Converted", value: converted, sub: pct(converted,total), filter: () => attendeesData.filter(x => x.Status?.toLowerCase() === "converted") },
    { title: "Unassigned", value: allMetrics.unassigned, filter: () => attendeesData.filter(x => !x.Assignees) },
    { title: "Missing Status", value: allMetrics.missingStatus, filter: () => attendeesData.filter(x => !x.Status) },
    { title: "Total Expense", value: "Rs " + totalExpense }
  ];

  document.getElementById("cards").innerHTML = cards.map((c,i)=>`
    <div class="card" onclick="applyFilter(${i})">
      <div class="card-title">${c.title}</div>
      <div class="card-value">${c.value}</div>
      ${c.sub ? `<div class="card-sub">${c.sub}</div>` : ""}
    </div>
  `).join("");

  window.cardFilters = cards;
}

function pct(v,total){
  if(total===0) return "";
  return ((v/total)*100).toFixed(1)+"%";
}

function applyFilter(index){
  const dataset = window.cardFilters[index].filter ? window.cardFilters[index].filter() : attendeesData;
  openTab("people");
  renderPeopleTable(dataset);
}

// =========================
//     PEOPLE TABLE
// =========================
function renderPeopleTable(data){
  if (!data || data.length === 0) {
    document.getElementById('peopleTable').innerHTML = "<tr><td>No Data</td></tr>";
    return;
  }

  const headers = Object.keys(data[0]);
  let html = "<tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr>";

  data.forEach(row=>{
    html += "<tr>" + headers.map(h=>`<td>${row[h]||""}</td>`).join("") + "</tr>";
  });

  document.getElementById('peopleTable').innerHTML = html;
}

// =========================
//     INSIGHTS (Paragraph)
// =========================
function renderInsights(){
  const total = attendeesData.length;

  // COUNTRY INSIGHT
  const countryMap = groupCount(attendeesData, "Country");
  const topCountry = Object.entries(countryMap).sort((a,b)=>b[1]-a[1])[0];
  const countryText = topCountry
    ? `${topCountry[0]} contributes the highest attendees with ${topCountry[1]} people, making up ${(topCountry[1]/total*100).toFixed(1)}% of total visitors.`
    : `Country data is not available.`;

  // STATUS INSIGHT
  const lost = allMetrics.lost;
  const warm = allMetrics.warm;
  const cold = allMetrics.cold;
  const converted = attendeesData.filter(x => (x.Status || "").toLowerCase() === "converted").length;

  const statusText =
    `Lost leads remain the biggest segment at ${(lost/total*100).toFixed(1)}%. ` +
    `Warm and Cold leads together form ${( (warm+cold)/total*100 ).toFixed(1)}%, showing mixed interest. ` +
    `Converted leads stand at ${(converted/total*100).toFixed(1)}%, suggesting medium engagement quality.`;

  // ASSIGNEE INSIGHTS
  const assigneeMap = groupCount(attendeesData, "Assignees");
  const topAssignee = Object.entries(assigneeMap).sort((a,b)=>b[1]-a[1])[0];
  const assigneeText = topAssignee
    ? `${topAssignee[0]} handled the most attendees with ${topAssignee[1]}, representing ${(topAssignee[1]/total*100).toFixed(1)}% of all assignments. This may indicate a workload imbalance.`
    : `No assignee data recorded.`;

  // SALES REP INSIGHT
  const salesMap = groupCount(attendeesData, "Sales Rep");
  const topSales = Object.entries(salesMap).sort((a,b)=>b[1]-a[1])[0];
  const salesText = topSales
    ? `${topSales[0]} managed the most follow-ups (${topSales[1]} cases). This rep is handling a large share of attendee engagement compared to others.`
    : `Sales rep distribution is not available.`;

  document.getElementById("insightText").innerHTML = `
    <p>${countryText}</p>
    <p>${statusText}</p>
    <p>${assigneeText}</p>
    <p>${salesText}</p>
  `;
}

// =========================
//         CHARTS
// =========================
function renderCharts(){
  makeBarChart(
    "countryChart",
    groupCount(attendeesData, "Country"),
    (country)=> attendeesData.filter(x=> (x.Country||"").toLowerCase().includes(country.toLowerCase()))
  );

  makeBarChart(
    "assigneeChart",
    groupCount(attendeesData, "Assignees"),
    (asg)=> attendeesData.filter(x=> (x.Assignees||"").toLowerCase() === asg.toLowerCase())
  );

  makeBarChart(
    "salesChart",
    groupCount(attendeesData, "Sales Rep"),
    (rep)=> attendeesData.filter(x=> (x["Sales Rep"]||"").toLowerCase() === rep.toLowerCase())
  );
}

// =========================
//     GROUP COUNTER
// =========================
function groupCount(arr, field){
  const map = {};
  arr.forEach(x=>{
    const key = (x[field] || "").trim();
    if (!key) return;
    map[key] = (map[key] || 0) + 1;
  });
  return map;
}

// =========================
//  CLICKABLE BAR CHART
// =========================
function makeBarChart(canvasId, dataObj, clickFilter){
  const labels = Object.keys(dataObj);
  const values = Object.values(dataObj);

  const ctx = document.getElementById(canvasId).getContext("2d");

  const chart = new Chart(ctx,{
    type:"bar",
    data:{
      labels: labels,
      datasets:[{
        label:"Count",
        data: values,
        backgroundColor: "#00aaff88",
        borderColor: "#33c3ff",
        borderWidth: 2,
        hoverBackgroundColor:"#00c3ff",
        hoverBorderColor:"#00e1ff"
      }]
    },
    options:{
      onClick: (e)=>{
        const points = chart.getElementsAtEventForMode(e,'nearest',{intersect:true},true);
        if(points.length){
          const idx = points[0].index;
          const key = labels[idx];

          const filtered = clickFilter(key);

          openTab("people");
          renderPeopleTable(filtered);
        }
      },
      plugins:{
        legend:{labels:{color:"#9EC5FF"}},
      },
      scales:{
        x:{ticks:{color:"#9EC5FF"}},
        y:{ticks:{color:"#9EC5FF"}}
      }
    }
  });
}
    <div id="roi" class="tab-page" style="display:none;">
  <h2 style="padding-left:20px;color:#7AB8FF;">ROI & Event Spend Analysis</h2>

  <!-- ROI Cards -->
  <div class="card-grid" id="roiCards"></div>

  <!-- Expense Breakdown -->
  <div class="chart-box">
    <h3>Expense Breakdown</h3>
    <table id="expenseTable"></table>
  </div>
</div>
    <input 
  type="text" 
  id="searchInput" 
  placeholder="Search attendees..." 
  onkeyup="searchPeople()" 
  style="margin-bottom:15px;padding:10px;width:50%;border-radius:8px;border:1px solid #1C3B7A;background:#0a1433;color:#9EC5FF;">

</script>
<!-- END OF DASHBOARD SYSTEM -->
</body>
</html>

