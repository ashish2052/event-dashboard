<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Dashboard</title>

<style>
    body {
        margin: 0;
        background: #0e1425;
        font-family: 'Segoe UI', sans-serif;
        color: #fff;
    }

    .navbar {
        display: flex;
        gap: 20px;
        padding: 20px;
        background: #0c1120;
        border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .tab {
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        background: rgba(255,255,255,0.05);
        transition: 0.2s;
    }

    .tab.active {
        background: rgba(255,255,255,0.15);
    }

    .container {
        padding: 25px;
    }

    .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .card {
        background: rgba(255,255,255,0.05);
        padding: 20px;
        border-radius: 14px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.08);
    }

    .card h2 {
        margin: 0;
        font-size: 30px;
        font-weight: 600;
    }

    .card p {
        margin-top: 8px;
        color: #b7c3d3;
        font-size: 14px;
    }

    .hidden { display: none; }
</style>

</head>

<body>

<!-- NAVIGATION TABS -->
<div class="navbar">
    <div class="tab active" onclick="showTab('overview')">Overview</div>
    <div class="tab" onclick="showTab('attendees')">Attendees Details</div>
    <div class="tab" onclick="showTab('expenses')">Expenses</div>
</div>

<!-- OVERVIEW -->
<div id="overview" class="container">

    <h1>Event Overview</h1>

    <div class="cards">

        <div class="card">
            <h2 id="totalAttendees">0</h2>
            <p>Total Attendees</p>
        </div>

        <div class="card">
            <h2 id="totalConverted">0</h2>
            <p>Converted (% of total)</p>
        </div>

        <div class="card">
            <h2 id="totalLost">0</h2>
            <p>Lost (% of total)</p>
        </div>

        <div class="card">
            <h2 id="avgFollowUps">0</h2>
            <p>Average Follow Ups (Lost)</p>
        </div>

        <div class="card">
            <h2 id="eventCost">0</h2>
            <p>Total Event Cost</p>
        </div>

        <div class="card">
            <h2 id="coeCount">0</h2>
            <p>COE Obtained</p>
        </div>

        <div class="card">
            <h2 id="warmCold">0</h2>
            <p>Warm + Cold</p>
        </div>

    </div>
</div>

<!-- ATTENDEES TAB -->
<div id="attendees" class="container hidden">
    <h1>Attendees Details</h1>
</div>

<!-- EXPENSES TAB -->
<div id="expenses" class="container hidden">
    <h1>Expenses</h1>
</div>

<!-- SCRIPT -->
<script>
function showTab(tabName) {
    document.querySelectorAll(".container").forEach(el => el.classList.add("hidden"));
    document.getElementById(tabName).classList.remove("hidden");

    document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
    event.target.classList.add("active");
}

async function loadData() {
    const res = await fetch("https://novevent-report-worker.ashishoct34.workers.dev/");
    const data = await res.json();

    console.log("Worker Data:", data);

    const attendees = data.attendees || [];
    const expenses = data.expenses || [];

    // Helpers
    const getStatus = (x) => (x.Status || "").trim().toLowerCase();
    const getConvStatus = (x) => (x["Converted Status"] || "").trim().toLowerCase();
    const getFollow = (x) => parseInt(x["Follow up attempts"] || "0") || 0;

    // TOTAL ATTENDEES
    const total = attendees.length;

    // COUNT LOGIC
    const converted = attendees.filter(x => getStatus(x) === "converted").length;
    const lost = attendees.filter(x => getStatus(x) === "lost").length;
    const warm = attendees.filter(x => getStatus(x) === "warm").length;
    const cold = attendees.filter(x => getStatus(x) === "cold").length;

    // COE OBTAINED
    const coeObtained = attendees.filter(x =>
        getConvStatus(x).includes("coe")
    ).length;

    // AVG FOLLOW UPS FOR LOST
    const lostRows = attendees.filter(x => getStatus(x) === "lost");
    const lostFollowUps = lostRows.map(getFollow);

    const avgFollow = lostFollowUps.length
        ? (lostFollowUps.reduce((a,b) => a+b, 0) / lostFollowUps.length).toFixed(1)
        : 0;

    // TOTAL EXPENSE
    const totalExpense = expenses.length
        ? expenses.reduce((sum, e) => sum + (parseFloat(e.Amount) || 0), 0)
        : 0;

    // UPDATE UI
    document.getElementById("totalAttendees").textContent = total;

    document.getElementById("totalConverted").textContent =
        `${converted} (${((converted / total) * 100).toFixed(1)}%)`;

    document.getElementById("totalLost").textContent =
        `${lost} (${((lost / total) * 100).toFixed(1)}%)`;

    document.getElementById("avgFollowUps").textContent = avgFollow;

    document.getElementById("eventCost").textContent =
        "â‚¹ " + totalExpense.toLocaleString();

    document.getElementById("coeCount").textContent = coeObtained;

    document.getElementById("warmCold").textContent = warm + cold;
}

loadData();
</script>

</body>
</html>
